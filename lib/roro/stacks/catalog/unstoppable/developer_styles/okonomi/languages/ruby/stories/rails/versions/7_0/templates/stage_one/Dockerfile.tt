FROM ruby:<%= @env[:base][:ruby_version][:value] %>-alpine AS builder

# Add basic packages
RUN apk add --no-cache \
      build-base \
      postgresql-dev \
      git \
      nodejs \
      tzdata \
      file

WORKDIR /app

## Create a Gemfile with just the Rails gem inside:
RUN echo -e "source 'https://rubygems.org'\ngem 'rails', '<%= @env[:base][:rails_version][:value] %>'" > Gemfile
RUN gem install bundler:<%= @env[:base][:bundler_version][:value] %>
RUN bundle config --local && \
  bundle install -j4 --retry 3

## Use Rails to generate a new app. We'll configure it later.
RUN bundle exec rails new . \
  --database=postgresql \
  --skip-bundle \
  --skip-webpack-install

FROM scratch AS export-stage

## Copy the generated files onto the host.
COPY --from=builder ./app/ .