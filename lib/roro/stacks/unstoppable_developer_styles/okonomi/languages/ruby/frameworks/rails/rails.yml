preface: A dynamic, open source programming language with a focus on simplicity and productivity. It has an elegant
  syntax that is natural to read and easy to write.

env:
  base:
    app_name:
      name: Name for your app
      value: unstoppable_app
    DATABASE_NAME:
      name: Database name
      value: postgres
    DATABASE_PASSWORD:
      name: Database password
      value: postgres
    DATABASE_USERNAME:
      name: Database username
      value: postgres
    DATABASE_HOST:
      name: Database host
      value: database
    POSTGRES_NAME:
      name: Database name
      value: ${DATABASE_NAME}
    POSTGRES_PASSWORD:
      name: Database password
      value: ${DATABASE_PASSWORD}
    POSTGRES_USERNAME:
      name: Database username
      value: ${DATABASE_USERNAME}
    POSTGRES_HOST:
      name: Database host
      value: ${DATABASE_HOST}

actions:
  - directory 'stage_one', '.', @env
  - inject_into_file('Dockerfile', partial('packages'), :after => 'AS builder')
  - run 'DOCKER_BUILDKIT=1 docker build --file Dockerfile --output . .'
  - run 'sudo chown -R $USER:$USER .'
  - directory 'stage_two', '.', @env
  - chmod 'entrypoints/docker-entrypoint.sh', 0755

  - |
    insert_into_file(
      'docker-compose.yml', 
      partial('service_app'),
      :after => "\nservices:")
  - insert_into_file 'Dockerfile', partial('packages'), :after => '2.7.4-alpine'
  - insert_into_file(
      'docker-compose.yml',
      "\n\s\sgem_cache:\n\s\snode_modules:",
      :after => "\nvolumes:")
  - |
    generator = Roro::CLI.new
    generator.generate_mise
    generator.generate_containers 'app', 'database', 'redis', 'sidekiq'
    generator.generate_environments @env
    generator.generate_keys
