commands:
    artifact-copy:
        steps:
            - run:
                command: |
                    sudo docker cp $(sudo docker ps -aqf "name=${APP_NAME}"):/artifact ./${APP_NAME}
                name: Artifact copy from container to host
    artifact-generate:
        steps:
            - run:
                command: |
                    sudo docker run \
                      --name ${APP_NAME} \
                      -v ${PWD}:/${APP_NAME} \
                      -v /var/run/docker.sock:/var/run/docker.sock \
                      -u 0 \
                      -it handsomefencer/roro:latest \
                      sh -c "printf '${ANSWERS}\na\n' | roro rollon"
                name: Artifact generate in roro container
    artifact-up:
        steps:
            - run:
                command: "docker volume rm $(docker volume ls --filter name=test-adventures -q) \n"
                name: Remove cached gem volumes to prevent clash
            - run:
                command: "cd ${APP_NAME} \nsudo docker-compose build \nsudo docker-compose up -d\n"
                name: Artifact up using docker-compose
    restore-and-save-cache:
        steps:
            - restore_cache:
                key: circlev2-{{ checksum "Gemfile.lock" }}
            - run: bundle config set --local path 'vendor/bundle'
            - run: bundle check || bundle install --jobs=4 --retry=3
            - run: gem build roro.gemspec
            - save_cache:
                key: circlev2-{{ checksum "Gemfile.lock" }}
                paths:
                    - vendor/bundle
    set-variables:
        steps:
            - run:
                command: |
                    echo "APP_NAME=${CIRCLE_JOB//\\n/-}" >> "$BASH_ENV"
                name: Store answers and app_name variables
executors:
    docker-cimg-base:
        docker:
            - image: cimg/base:2023.06
    docker-cimg-ruby:
        docker:
            - image: cimg/ruby:<<parameters.version>>
        parameters:
            version:
                default: 3.2.2
                description: version tag
                type: string
    machine-osx:
        macos:
            xcode: 14.2.0
    machine-ubuntu:
        machine:
            docker_layer_caching: true
            image: ubuntu-2204:2023.04.2
jobs:
    build:
        executor: machine-ubuntu
        steps:
            - checkout
    release:
        executor: docker-cimg-ruby
        steps:
            - checkout
            - run: |
                git config --global user.email "fred.schoeneman@gmail.com"
                git config --global user.name "Fred Schoeneman"
            - run: gem install gem-release
            - run: gem bump
            - run: gem release
    roro-image-build:
        executor: machine-ubuntu
        steps:
            - checkout
            - run: |
                sudo chown -R $USER:$USER .
                sudo env UID=${UID} GID=${GID} docker-compose build roro
    roro-image-push:
        executor: machine-ubuntu
        steps:
            - checkout
            - run: docker-compose run -e CI_KEY=${CI_KEY} --rm roro roro generate:exposed
            - run: |
                echo ${DOCKERHUB_TOKEN} | docker login \
                  -u ${DOCKERHUB_USERNAME} \
                  --password-stdin
            - run: "docker tag handsomefencer/roro handsomefencer/roro:latest \ndocker tag handsomefencer/roro handsomefencer/roro:${CIRCLE_SHA1} \n"
            - run: |-
                docker image push handsomefencer/roro:latest
                docker image push handsomefencer/roro:${CIRCLE_SHA1}
    test-adventures:
        environment:
            - ANSWERS: << parameters.answers >>
        executor: << parameters.os >>
        parameters:
            answers:
                default: 1\1
                type: string
            os:
                default: docker-cimg-base
                type: executor
        steps:
            - checkout
            - set-variables
            - artifact-generate
            - artifact-copy
            - artifact-up
    test-rubies:
        executor: docker-cimg-ruby
        parameters:
            version:
                default: "3.0"
                description: version tag
                type: string
        steps:
            - checkout
            - run: gem install bundler
            - run: bundle
            - run: bundle exec rake test
version: 2.1
workflows:
    adventures:
        jobs:
            - build
            - roro-image-build
            - test-adventures:
                filters:
                    branches:
                        only:
                            - development
                matrix:
                    parameters:
                        answers:
                            - 1\n1\n1\n1
                            - 1\n1\n1\n2
                            - 1\n1\n2\n1
                            - 1\n1\n2\n2
                            - 1\n2\n1\n1
                            - 1\n2\n1\n2
                            - 1\n2\n2\n1
                            - 1\n2\n2\n2
                            - 1\n3\n1\n1
                            - 1\n3\n1\n2
                            - 1\n3\n2\n1
                            - 1\n3\n2\n2
                            - 1\n4\n1\n1
                            - 1\n4\n1\n2
                            - 1\n4\n2\n1
                            - 1\n4\n2\n2
                            - "2"
                        os:
                            - machine-ubuntu
                requires:
                    - roro-image-build
    gem-release:
        jobs:
            - release:
                filters:
                    branches:
                        only:
                            - gem-release
    release-image:
        jobs:
            - roro-image-push:
                filters:
                    branches:
                        only:
                            - release-image
    rubies:
        jobs:
            - test-rubies:
                filters:
                    branches:
                        only: rubies
                matrix:
                    parameters:
                        version:
                            - "3.0"
                            - "2.7"
                            - "2.6"
                            - "2.5"

