commands:
    restore-and-save-cache:
        steps:
            - restore_cache:
                key: circlev2-{{ checksum "Gemfile.lock" }}
            - run: bundle config set --local path 'vendor/bundle'
            - run: bundle check || bundle install --jobs=4 --retry=3
            - run: gem build roro.gemspec
            - save_cache:
                key: circlev2-{{ checksum "Gemfile.lock" }}
                paths:
                    - vendor/bundle
executors:
    ruby:
        docker:
            - image: cimg/ruby:<<parameters.version>>
        parameters:
            version:
                default: 3.2.2
                description: version tag
                type: string
jobs:
    build:
        executor:
            name: ruby
        steps:
            - checkout
            - restore-and-save-cache
            - setup_remote_docker:
                docker_layer_caching: true
                version: 20.10.24
            - run: sudo docker-compose build roro
    release:
        executor:
            name: ruby
        steps:
            - checkout
            - run: |
                git config --global user.email "fred.schoeneman@gmail.com"
                git config --global user.name "Fred Schoeneman"
            - run: gem install gem-release
            - run: gem bump
            - run: gem release
    test-adventures:
        executor: << parameters.os >>
        parameters:
            answers:
                default: 1\1
                type: string
            os:
                default: ruby
                type: executor
        steps:
            - setup_remote_docker:
                docker_layer_caching: true
                version: 20.10.24
            - run:
                command: |
                    echo 'export answers=<< parameters.answers>>' >> "$BASH_ENV"
                    echo 'export app_name=artifact-${answers//\\/-}' >> "$BASH_ENV"
                    echo 'export container=$(sudo docker ps -aqf "name=${app_name}")' >> "$BASH_ENV"
                name: Setup job environment variables
            - run: echo ${answers}
            - run: echo ${app_name}
            - run: |
                sudo docker run \
                  --name ${app_name} \
                  -v ${PWD}:/${app_name} \
                  -v /var/run/docker.sock:/var/run/docker.sock \
                  -u 0 \
                  -it handsomefencer/roro:latest \
                  sh -c "printf '<< parameters.answers >>\na\n' | roro rollon"
            - run:
                command: |
                    answers=<< parameters.answers >>
                    app_name="artifact-${answers//\\/-}"
                    container="$(sudo docker ps -aqf 'name=${app_name}')"
                    echo 'export answers=${answers}' >> "$BASH_ENV"
                    echo 'export app_name=${app_name}' >> "$BASH_ENV"
                    echo 'export container=${container}' >> "$BASH_ENV"
                name: Store container id as variable
            - run:
                command: "echo ${container}    \necho ${answers}    \necho ${app_name}    \n"
                name: show variables
            - run: "sudo docker cp ${container}:/${app_name}/. ./\necho ${PWD}\nls -a\nls -a /home/circleci/sandbox/\ndocker cp ${container}:/artifact/. ${PWD}/\nsudo docker-compose build \nsudo docker-compose up -d\n"
        working_directory: ~/sandbox
    test-rubies:
        executor:
            name: ruby
            version: <<parameters.version>>
        parameters:
            version:
                default: "3.0"
                description: version tag
                type: string
        steps:
            - checkout
            - run: gem install bundler
            - run: bundle
            - run: bundle exec rake test:test
            - run: bundle exec rake test:stacks
version: 2.1
workflows:
    adventures:
        jobs:
            - build
            - test-adventures:
                filters:
                    branches:
                        only:
                            - adventures
                matrix:
                    parameters:
                        answers:
                            - 1\n1\n1
                        os:
                            - ruby
                requires:
                    - build
    gem-release:
        jobs:
            - build
            - release:
                filters:
                    branches:
                        only:
                            - gem-release
    rubies:
        jobs:
            - test-rubies:
                filters:
                    branches:
                        only: rubies
                matrix:
                    parameters:
                        version:
                            - "3.0"
                            - "2.7"
                            - "2.6"
                            - "2.5"

